<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>simba.mixins.image_mixin &mdash; SimBA 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/simba_theme.css" />
      <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />

  
    <link rel="shortcut icon" href="../../../_static/readthedocs_logo.png"/>
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script>let toggleHintShow = 'Click to show';</script>
        <script>let toggleHintHide = 'Click to hide';</script>
        <script>let toggleOpenOnPrint = 'true';</script>
        <script src="../../../_static/togglebutton.js"></script>
        <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            SimBA
              <img src="../../../_static/readthedocs_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">API REFERENCE:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">NOTEBOOKS:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks.html">Notebooks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">USER GUIDE / TUTORIALS:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">WALKTHROUGHS:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../walkthroughs.html">Walkthroughs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">LABELLING TUTORIALS:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../labelling.html">Labelling</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">FAQ:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials_rst/FAQ.html">Friendly Asked Questions (FAQ)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">DOCS:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../docs/workflow.html">SimBA basic workflow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ABOUT:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../credits.html#who-writes-this-stuff">Who writes this stuff??</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../links.html">Links</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">SimBA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">simba.mixins.image_mixin</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for simba.mixins.image_mixin</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Literal</span>
<span class="k">except</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">ChainMap</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">int64</span><span class="p">,</span> <span class="n">jit</span><span class="p">,</span> <span class="n">njit</span><span class="p">,</span> <span class="n">prange</span><span class="p">,</span> <span class="n">uint8</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">skimage.metrics</span> <span class="kn">import</span> <span class="n">structural_similarity</span>

<span class="kn">from</span> <span class="nn">simba.utils.checks</span> <span class="kn">import</span> <span class="p">(</span><span class="n">check_file_exist_and_readable</span><span class="p">,</span> <span class="n">check_float</span><span class="p">,</span>
                                <span class="n">check_if_dir_exists</span><span class="p">,</span> <span class="n">check_if_valid_img</span><span class="p">,</span>
                                <span class="n">check_if_valid_rgb_tuple</span><span class="p">,</span> <span class="n">check_instance</span><span class="p">,</span>
                                <span class="n">check_int</span><span class="p">,</span> <span class="n">check_nvidea_gpu_available</span><span class="p">,</span>
                                <span class="n">check_str</span><span class="p">,</span> <span class="n">check_valid_array</span><span class="p">,</span>
                                <span class="n">check_valid_boolean</span><span class="p">,</span> <span class="n">check_valid_lst</span><span class="p">,</span>
                                <span class="n">check_valid_tuple</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">simba.utils.enums</span> <span class="kn">import</span> <span class="n">Defaults</span><span class="p">,</span> <span class="n">Formats</span><span class="p">,</span> <span class="n">GeometryEnum</span><span class="p">,</span> <span class="n">Options</span>
<span class="kn">from</span> <span class="nn">simba.utils.errors</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ArrayError</span><span class="p">,</span> <span class="n">FFMPEGCodecGPUError</span><span class="p">,</span>
                                <span class="n">FrameRangeError</span><span class="p">,</span> <span class="n">InvalidInputError</span><span class="p">,</span>
                                <span class="n">NotDirectoryError</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">simba.utils.printing</span> <span class="kn">import</span> <span class="n">SimbaTimer</span><span class="p">,</span> <span class="n">stdout_success</span>
<span class="kn">from</span> <span class="nn">simba.utils.read_write</span> <span class="kn">import</span> <span class="p">(</span><span class="n">find_core_cnt</span><span class="p">,</span>
                                    <span class="n">find_files_of_filetypes_in_directory</span><span class="p">,</span>
                                    <span class="n">find_largest_blob_location</span><span class="p">,</span> <span class="n">get_fn_ext</span><span class="p">,</span>
                                    <span class="n">get_video_meta_data</span><span class="p">,</span> <span class="n">read_frm_of_video</span><span class="p">,</span>
                                    <span class="n">read_img_batch_from_video_gpu</span><span class="p">,</span> <span class="n">write_df</span><span class="p">)</span>


<div class="viewcode-block" id="ImageMixin"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin">[docs]</a><span class="k">class</span> <span class="nc">ImageMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Methods to slice and compute attributes of images and comparing those attributes across sequential images.</span>

<span class="sd">    This can be helpful when the behaviors studied are very subtle and the signal is very low in relation to the</span>
<span class="sd">    noise within the pose-estimated data. In these use-cases, we cannot use pose-estimated data directly, and we instead</span>
<span class="sd">    study histograms, contours and other image metrics within images derived from the intersection of geometries</span>
<span class="sd">    (like a circle around the nose) across sequential images. Often these methods are called using image masks created from</span>
<span class="sd">    pose-estimated points within ``simba.mixins.geometry_mixin.GeometryMixin`` methods.</span>

<span class="sd">    .. important::</span>
<span class="sd">        If there is non-pose related noise in the environment (e.g., there are non-experiment related light sources that goes on and off, or other image noise that doesn&#39;t necesserily affect pose-estimation reliability),</span>
<span class="sd">        this will negatively affect the reliability of most image attribute comparisons.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="ImageMixin.brightness_intensity"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.brightness_intensity">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">brightness_intensity</span><span class="p">(</span><span class="n">imgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">ignore_black</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the average brightness intensity within each image within a list.</span>

<span class="sd">        For example, (i) create a list of images containing a light cue ROI, (ii) compute brightness in each image, (iii) perform kmeans on brightness, and get the frames when the light cue is on vs off.</span>

<span class="sd">        :param List[np.ndarray] imgs: List of images as arrays to calculate average brightness intensity within.</span>
<span class="sd">        :param Optional[bool] ignore_black: If True, ignores black pixels. If the images are sliced non-rectangular geometric shapes created by ``slice_shapes_in_img``, then pixels that don&#39;t belong to the shape has been masked in black.</span>
<span class="sd">        :returns List[float]: List of floats of size len(imgs) with brightness intensities.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; img = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/0.png&#39;).astype(np.uint8)</span>
<span class="sd">        &gt;&gt;&gt; ImageMixin.brightness_intensity(imgs=[img], ignore_black=False)</span>
<span class="sd">        &gt;&gt;&gt; [159.0]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">check_instance</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">brightness_intensity</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> imgs&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">imgs</span><span class="p">,</span> <span class="n">accepted_types</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">img</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imgs</span><span class="p">):</span>
            <span class="n">check_instance</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">brightness_intensity</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> img </span><span class="si">{</span><span class="n">cnt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">instance</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
                <span class="n">accepted_types</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ignore_black</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">img</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">img</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">results</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">gaussian_blur</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">)):</span>
        <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">gaussian_blur</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">check_instance</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">gaussian_blur</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span> <span class="n">accepted_types</span><span class="o">=</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,))</span>
        <span class="n">check_valid_lst</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">),</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">gaussian_blur</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">valid_dtypes</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">,),</span> <span class="n">exact_len</span><span class="o">=</span><span class="mi">2</span><span class="p">,)</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">GaussianBlur</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">erode</span><span class="p">(</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">kernel_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
        <span class="n">iterations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">gaussian_blur</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">check_instance</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">gaussian_blur</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">kernel_size</span><span class="p">,</span>
            <span class="n">accepted_types</span><span class="o">=</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="n">check_valid_lst</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">kernel_size</span><span class="p">),</span>
            <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">gaussian_blur</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">valid_dtypes</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">,),</span>
            <span class="n">exact_len</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">erode</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">iterations</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">erode</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

<div class="viewcode-block" id="ImageMixin.get_histocomparison"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.get_histocomparison">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_histocomparison</span><span class="p">(</span>
        <span class="n">img_1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">img_2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span>
            <span class="n">Literal</span><span class="p">[</span>
                <span class="s2">&quot;chi_square&quot;</span><span class="p">,</span>
                <span class="s2">&quot;correlation&quot;</span><span class="p">,</span>
                <span class="s2">&quot;intersection&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bhattacharyya&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hellinger&quot;</span><span class="p">,</span>
                <span class="s2">&quot;chi_square_alternative&quot;</span><span class="p">,</span>
                <span class="s2">&quot;kl_divergence&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;correlation&quot;</span><span class="p">,</span>
        <span class="n">absolute</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; img_1 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/0.png&#39;).astype(np.uint8)</span>
<span class="sd">        &gt;&gt;&gt; img_2 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/3.png&#39;).astype(np.uint8)</span>
<span class="sd">        &gt;&gt;&gt; ImageMixin.get_histocomparison(img_1=img_1, img_2=img_2, method=&#39;chi_square_alternative&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_if_valid_img</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">get_histocomparison</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> img_1&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">img_1</span>
        <span class="p">)</span>
        <span class="n">check_if_valid_img</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">get_histocomparison</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> img_2&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">img_2</span>
        <span class="p">)</span>
        <span class="n">check_str</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">get_histocomparison</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> method&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">GeometryEnum</span><span class="o">.</span><span class="n">HISTOGRAM_COMPARISON_MAP</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">GeometryEnum</span><span class="o">.</span><span class="n">HISTOGRAM_COMPARISON_MAP</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">method</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">absolute</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span>
                <span class="n">cv2</span><span class="o">.</span><span class="n">compareHist</span><span class="p">(</span>
                    <span class="n">img_1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">img_2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">method</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">compareHist</span><span class="p">(</span>
                <span class="n">img_1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">img_2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">method</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="ImageMixin.get_contourmatch"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.get_contourmatch">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_contourmatch</span><span class="p">(</span><span class="n">img_1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                         <span class="n">img_2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                         <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;exterior&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
                         <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;simple&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;l2&quot;</span><span class="p">,</span> <span class="s2">&quot;kcos&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;simple&quot;</span><span class="p">,</span>
                         <span class="n">canny</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate contour similarity between two images.</span>

<span class="sd">        :param np.ndarray img_1: First input image (numpy array).</span>
<span class="sd">        :param np.ndarray img_2: Second input image (numpy array).</span>
<span class="sd">        :param Optional[Literal[&#39;all&#39;, &#39;exterior&#39;]] method: Method for contour extraction. Options: &#39;all&#39; (all contours) or &#39;exterior&#39; (only exterior contours). Defaults to &#39;all&#39;.</span>
<span class="sd">        :return float: Contour similarity score between the two images. Lower values indicate greater similarity, and higher values indicate greater dissimilarity.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; img_1 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/0.png&#39;).astype(np.uint8)</span>
<span class="sd">        &gt;&gt;&gt; img_2 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/3.png&#39;).astype(np.uint8)</span>
<span class="sd">        &gt;&gt;&gt; ImageMixin.get_contourmatch(img_1=img_1, img_2=img_2, method=&#39;exterior&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_if_valid_img</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">get_contourmatch</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> img_1&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">img_1</span>
        <span class="p">)</span>
        <span class="n">check_if_valid_img</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">get_contourmatch</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> img_2&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">img_2</span>
        <span class="p">)</span>
        <span class="n">check_str</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">get_contourmatch</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> mode&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">GeometryEnum</span><span class="o">.</span><span class="n">CONTOURS_MODE_MAP</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="n">check_str</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">find_contours</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> method&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">GeometryEnum</span><span class="o">.</span><span class="n">CONTOURS_RETRIEVAL_MAP</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">canny</span><span class="p">:</span>
            <span class="n">img_1</span> <span class="o">=</span> <span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">canny_edge_detection</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">img_1</span><span class="p">)</span>
            <span class="n">img_2</span> <span class="o">=</span> <span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">canny_edge_detection</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">img_2</span><span class="p">)</span>
        <span class="n">img_1_contours</span> <span class="o">=</span> <span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">find_contours</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">img_1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="n">img_2_contours</span> <span class="o">=</span> <span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">find_contours</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">img_2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">matchShapes</span><span class="p">(</span>
            <span class="n">img_1_contours</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">img_2_contours</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cv2</span><span class="o">.</span><span class="n">CONTOURS_MATCH_I1</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ImageMixin.slice_shapes_in_img"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.slice_shapes_in_img">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">slice_shapes_in_img</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">geometries</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Slice regions of interest (ROIs) from an image based on provided shapes.</span>

<span class="sd">        .. note::</span>
<span class="sd">           Use for slicing one or several static geometries from a single image. If you have several images,</span>
<span class="sd">           and shifting geometries across images, consider ``simba.mixins.image_mixin.ImageMixin.slice_shapes_in_imgs``</span>
<span class="sd">           which uses CPU multiprocessing.</span>

<span class="sd">        :param Union[np.ndarray, Tuple[cv2.VideoCapture, int]] img: Either an image in numpy array format OR a tuple with cv2.VideoCapture object and the frame index.</span>
<span class="sd">        :param List[Union[Polygon, np.ndarray]] img: A list of shapes either as vertices in a numpy array, or as shapely Polygons.</span>
<span class="sd">        :returns List[np.ndarray]: List of sliced ROIs from the input image.</span>

<span class="sd">        &gt;&gt;&gt; img = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/Emergence/project_folder/videos/img_comparisons_4/1.png&#39;)</span>
<span class="sd">        &gt;&gt;&gt; img_video = cv2.VideoCapture(&#39;/Users/simon/Desktop/envs/troubleshooting/Emergence/project_folder/videos/Example_1.mp4&#39;)</span>
<span class="sd">        &gt;&gt;&gt; data_path = &#39;/Users/simon/Desktop/envs/troubleshooting/Emergence/project_folder/csv/outlier_corrected_movement_location/Example_1.csv&#39;</span>
<span class="sd">        &gt;&gt;&gt; data = pd.read_csv(data_path, nrows=4, usecols=[&#39;Nose_x&#39;, &#39;Nose_y&#39;]).fillna(-1).values.astype(np.int64)</span>
<span class="sd">        &gt;&gt;&gt; shapes = []</span>
<span class="sd">        &gt;&gt;&gt; for frm_data in data: shapes.append(GeometryMixin().bodyparts_to_circle(frm_data, 100))</span>
<span class="sd">        &gt;&gt;&gt; ImageMixin().slice_shapes_in_img(img=(img_video, 1), shapes=shapes)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">check_instance</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">slice_shapes_in_img</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> img&quot;</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
            <span class="n">accepted_types</span><span class="o">=</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">check_instance</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">slice_shapes_in_img</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> shapes&quot;</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="n">geometries</span><span class="p">,</span>
            <span class="n">accepted_types</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">shape_cnt</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">geometries</span><span class="p">):</span>
            <span class="n">check_instance</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">slice_shapes_in_img</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> shapes </span><span class="si">{</span><span class="n">shape_cnt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">instance</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">accepted_types</span><span class="o">=</span><span class="p">(</span><span class="n">Polygon</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">check_instance</span><span class="p">(</span>
                <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">slice_shapes_in_img</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> img tuple first entry&quot;</span><span class="p">,</span>
                <span class="n">instance</span><span class="o">=</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">accepted_types</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">frm_cnt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">CAP_PROP_FRAME_COUNT</span><span class="p">))</span>
            <span class="n">check_int</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">slice_shapes_in_img</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> video frame count&quot;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">img</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">max_value</span><span class="o">=</span><span class="n">frm_cnt</span><span class="p">,</span>
                <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">img</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">corrected_shapes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">geometries</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">shape</span><span class="p">[</span><span class="n">shape</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">corrected_shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                <span class="n">shape</span><span class="p">[</span><span class="n">shape</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">corrected_shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">shapes</span> <span class="o">=</span> <span class="n">corrected_shapes</span>
        <span class="k">del</span> <span class="n">corrected_shapes</span>
        <span class="k">for</span> <span class="n">shape_cnt</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shapes</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">roi_img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">roi_img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span>
                <span class="n">mask</span><span class="p">,</span> <span class="p">[</span><span class="n">shape</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span>
            <span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">roi_img</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="ImageMixin.canny_edge_detection"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.canny_edge_detection">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">canny_edge_detection</span><span class="p">(</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">threshold_1</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">threshold_2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
        <span class="n">aperture_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">l2_gradient</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply Canny edge detection to the input image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">canny_edge_detection</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">canny_edge_detection</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> threshold_1&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">threshold_1</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">canny_edge_detection</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> threshold_2&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">threshold_2</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">canny_edge_detection</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> aperture_size&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">aperture_size</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">Canny</span><span class="p">(</span>
            <span class="n">img</span><span class="p">,</span>
            <span class="n">threshold1</span><span class="o">=</span><span class="n">threshold_1</span><span class="p">,</span>
            <span class="n">threshold2</span><span class="o">=</span><span class="n">threshold_2</span><span class="p">,</span>
            <span class="n">apertureSize</span><span class="o">=</span><span class="n">aperture_size</span><span class="p">,</span>
            <span class="n">L2gradient</span><span class="o">=</span><span class="n">l2_gradient</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="ImageMixin.img_moments"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.img_moments">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">img_moments</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">hu_moments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute image moments.</span>

<span class="sd">        :param np.ndarray img: The input image.</span>
<span class="sd">        :param  Optional[bool] img: If True, returns the 7 Hu moments. Else, returns the moments.</span>
<span class="sd">        :returns np.ndarray: A 24x1 2d-array if hu_moments is False, 7x1 2d-array if hu_moments is True.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; img_1 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/0.png&#39;).astype(np.uint8)</span>
<span class="sd">        &gt;&gt;&gt; ImageMixin.img_moments(img=img_1, hu_moments=True)</span>
<span class="sd">        &gt;&gt;&gt; [[ 1.01270313e-03], [ 8.85983106e-10], [ 4.67680675e-13], [ 1.00442018e-12], [-4.64181508e-25], [-2.49036749e-17], [ 5.08375216e-25]]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">img_moments</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">hu_moments</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">HuMoments</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">img</span><span class="p">))</span></div>

<div class="viewcode-block" id="ImageMixin.find_contours"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.find_contours">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">find_contours</span><span class="p">(</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;exterior&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;simple&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;l1&quot;</span><span class="p">,</span> <span class="s2">&quot;kcos&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;simple&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find contours in the input image.</span>

<span class="sd">        :param np.ndarray img: Input image as a NumPy array.</span>
<span class="sd">        :param Optional[Literal[&#39;all&#39;, &#39;exterior&#39;]] img: Contour retrieval mode. E.g., which contours should be kept. Default is &#39;all&#39;.</span>
<span class="sd">        :param Optional[Literal[&#39;simple&#39;, &#39;none&#39;, &#39;l1&#39;, &#39;kcos&#39;]]: Contour approximation method. Default is &#39;simple&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">find_contours</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> img&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">)</span>
        <span class="n">check_str</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">find_contours</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> mode&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">GeometryEnum</span><span class="o">.</span><span class="n">CONTOURS_MODE_MAP</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">check_str</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">find_contours</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> method&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">GeometryEnum</span><span class="o">.</span><span class="n">CONTOURS_RETRIEVAL_MAP</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">mode</span> <span class="o">=</span> <span class="n">GeometryEnum</span><span class="o">.</span><span class="n">CONTOURS_MODE_MAP</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>
        <span class="n">method</span> <span class="o">=</span> <span class="n">GeometryEnum</span><span class="o">.</span><span class="n">CONTOURS_RETRIEVAL_MAP</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">method</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">method</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cnts</span><span class="p">,</span> <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">method</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># TODO</span>
            <span class="n">interior_contours</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cnts</span><span class="p">)):</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">hierarchy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
                <span class="p">):</span>  <span class="c1"># Contour with no parent (interior contour)</span>
                    <span class="n">interior_contours</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cnts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span></div>

<div class="viewcode-block" id="ImageMixin.orb_matching_similarity_"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.orb_matching_similarity_">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">orb_matching_similarity_</span><span class="p">(</span><span class="n">img_1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                 <span class="n">img_2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                 <span class="n">method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;knn&quot;</span><span class="p">,</span> <span class="s2">&quot;match&quot;</span><span class="p">,</span> <span class="s2">&quot;radius&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;knn&quot;</span><span class="p">,</span>
                                 <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>


<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform ORB feature matching between two sets of images.</span>

<span class="sd">        &gt;&gt;&gt; img_1 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/0.png&#39;).astype(np.uint8)</span>
<span class="sd">        &gt;&gt;&gt; img_2 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/10.png&#39;).astype(np.uint8)</span>
<span class="sd">        &gt;&gt;&gt; ImageMixin().orb_matching_similarity_(img_1=img_1, img_2=img_2, method=&#39;radius&#39;)</span>
<span class="sd">        &gt;&gt;&gt; 4</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">kp1</span><span class="p">,</span> <span class="n">des1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ORB_create</span><span class="p">()</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img_1</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="n">kp2</span><span class="p">,</span> <span class="n">des2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">ORB_create</span><span class="p">()</span><span class="o">.</span><span class="n">detectAndCompute</span><span class="p">(</span><span class="n">img_2</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="n">sliced_matches</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;knn&quot;</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">()</span><span class="o">.</span><span class="n">knnMatch</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">sliced_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">matches</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">n</span><span class="o">.</span><span class="n">distance</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;match&quot;</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">NORM_HAMMING</span><span class="p">,</span> <span class="n">crossCheck</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">)</span>
            <span class="n">sliced_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">match</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span> <span class="k">if</span> <span class="n">match</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;radius&quot;</span><span class="p">:</span>
            <span class="n">matches</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BFMatcher</span><span class="p">()</span><span class="o">.</span><span class="n">radiusMatch</span><span class="p">(</span><span class="n">des1</span><span class="p">,</span> <span class="n">des2</span><span class="p">,</span> <span class="n">maxDistance</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>
            <span class="n">sliced_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">sublist</span> <span class="ow">in</span> <span class="n">matches</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sublist</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">sliced_matches</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_template_matching_cpu_helper</span><span class="p">(</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">video_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="n">target_frm</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper called from ``simba.mixins.image_mixin.ImageMixins.template_matching_cpu()``&quot;&quot;&quot;</span>
        <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">current</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">while</span> <span class="n">current</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing frame </span><span class="si">{</span><span class="n">current</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">img</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">matchTemplate</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">target_frm</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">TM_CCOEFF_NORMED</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">max_loc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">minMaxLoc</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="n">current</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="s2">&quot;loc&quot;</span><span class="p">:</span> <span class="n">max_loc</span><span class="p">}</span>
            <span class="n">current</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">results</span>

<div class="viewcode-block" id="ImageMixin.template_matching_cpu"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.template_matching_cpu">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">template_matching_cpu</span><span class="p">(</span>
        <span class="n">video_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">core_cnt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">return_img</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform template matching on CPU using multiprocessing for parallelization.</span>

<span class="sd">        E.g., having a cropped image, find the image and frame number in a video it most likely has been cropped from.</span>

<span class="sd">        :param Union[str, os.PathLike] video_path: Path to the video file on disk.</span>
<span class="sd">        :param np.ndarray img: Template image for matching. E.g., a cropped image from ``video_path``.</span>
<span class="sd">        :param Optional[int] core_cnt: Number of CPU cores to use for parallel processing. Default is -1 (max available cores).</span>
<span class="sd">        :param Optional[bool] return_img: Whether to return the annotated best match image with rectangle around matched template area. Default is False.</span>
<span class="sd">        :returns Tuple[ int, dict, Union[None, np.ndarray]]: A tuple containing: (i) int: frame index of the frame with the best match.</span>
<span class="sd">                 (ii) dict: Dictionary containing results (probability and match location) for each frame.</span>
<span class="sd">                 (iii) Union[None, np.ndarray]: Annotated image with rectangles around matches (if return_img is True), otherwise None.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; img = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/two_black_animals_14bp/videos/Screenshot 2024-01-17 at 12.45.55 PM.png&#39;)</span>
<span class="sd">        &gt;&gt;&gt; results = ImageMixin().template_matching_cpu(video_path=&#39;/Users/simon/Desktop/envs/troubleshooting/two_black_animals_14bp/videos/Together_1.avi&#39;, img=img, return_img=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span><span class="p">,</span> <span class="n">found_img</span> <span class="o">=</span> <span class="p">[],</span> <span class="kc">None</span>
        <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">core_cnt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">core_cnt</span> <span class="o">=</span> <span class="n">find_core_cnt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">frame_cnt</span> <span class="o">=</span> <span class="n">get_video_meta_data</span><span class="p">(</span><span class="n">video_path</span><span class="o">=</span><span class="n">video_path</span><span class="p">)[</span><span class="s2">&quot;frame_count&quot;</span><span class="p">]</span>
        <span class="n">frm_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">frame_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frm_idx</span><span class="p">)</span> <span class="o">//</span> <span class="n">core_cnt</span>
        <span class="n">remainder</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frm_idx</span><span class="p">)</span> <span class="o">%</span> <span class="n">core_cnt</span>
        <span class="n">split_frm_idx</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">frm_idx</span><span class="p">[</span>
                <span class="n">i</span> <span class="o">*</span> <span class="n">chunk_size</span>
                <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">remainder</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunk_size</span>
                <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">remainder</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">core_cnt</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span>
            <span class="n">core_cnt</span><span class="p">,</span> <span class="n">maxtasksperchild</span><span class="o">=</span><span class="n">Defaults</span><span class="o">.</span><span class="n">LARGE_MAX_TASK_PER_CHILD</span><span class="o">.</span><span class="n">value</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">constants</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">_template_matching_cpu_helper</span><span class="p">,</span>
                <span class="n">video_path</span><span class="o">=</span><span class="n">video_path</span><span class="p">,</span>
                <span class="n">target_frm</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">constants</span><span class="p">,</span> <span class="n">split_frm_idx</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ChainMap</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">))</span>

        <span class="n">max_value</span><span class="p">,</span> <span class="n">max_frm</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_value</span><span class="p">:</span>
                <span class="n">max_value</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">]</span>
                <span class="n">max_frm</span> <span class="o">=</span> <span class="n">k</span>

        <span class="k">if</span> <span class="n">return_img</span><span class="p">:</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">found_img</span> <span class="o">=</span> <span class="n">read_frm_of_video</span><span class="p">(</span><span class="n">video_path</span><span class="o">=</span><span class="n">video_path</span><span class="p">,</span> <span class="n">frame_index</span><span class="o">=</span><span class="n">max_frm</span><span class="p">)</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">max_frm</span><span class="p">][</span><span class="s2">&quot;loc&quot;</span><span class="p">]</span>
            <span class="n">found_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">rectangle</span><span class="p">(</span>
                <span class="n">found_img</span><span class="p">,</span>
                <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span>
                <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">w</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">h</span><span class="p">)),</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">max_frm</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">found_img</span></div>

    <span class="k">def</span> <span class="nf">template_matching_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="ImageMixin.img_to_bw"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.img_to_bw">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">img_to_bw</span><span class="p">(</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">lower_thresh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">upper_thresh</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
        <span class="n">invert</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert an image to black and white (binary).</span>

<span class="sd">        .. image:: _static/img/img_to_bw.png</span>
<span class="sd">           :width: 600</span>
<span class="sd">           :align: center</span>

<span class="sd">        .. note::</span>
<span class="sd">           If converting multiple images from colour to black and white, consider ``simba.mixins.image_mixin.ImageMixin.img_stack_to_bw()``</span>


<span class="sd">        :param np.ndarray img: Input image as a NumPy array.</span>
<span class="sd">        :param Optional[int] lower_thresh: Lower threshold value for binary conversion. Pixels below this value become black. Default is 20.</span>
<span class="sd">        :param Optional[int] upper_thresh: Upper threshold value for binary conversion. Pixels above this value become white. Default is 250.</span>
<span class="sd">        :param Optional[bool] invert: Flag indicating whether to invert the binary image (black becomes white and vice versa). Default is True.</span>
<span class="sd">        :return np.ndarray: Binary black and white image.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">img_to_bw</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">img_to_bw</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> lower_thresh&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">lower_thresh</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">img_to_bw</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> upper_thresh&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">upper_thresh</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">invert</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">upper_thresh</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">~</span><span class="n">cv2</span><span class="o">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="n">upper_thresh</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">THRESH_BINARY</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="ImageMixin.img_stack_to_bw"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.img_stack_to_bw">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">img_stack_to_bw</span><span class="p">(</span>
        <span class="n">imgs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">lower_thresh</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">upper_thresh</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">invert</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a stack of color images into black and white format.</span>

<span class="sd">        .. note::</span>
<span class="sd">           If converting a single image, consider ``simba.mixins.image_mixin.ImageMixin.img_to_bw()``</span>

<span class="sd">        :param np.ndarray img: 4-dimensional array of color images.</span>
<span class="sd">        :param Optional[int] lower_thresh: Lower threshold value for binary conversion. Pixels below this value become black. Default is 20.</span>
<span class="sd">        :param Optional[int] upper_thresh: Upper threshold value for binary conversion. Pixels above this value become white. Default is 250.</span>
<span class="sd">        :param Optional[bool] invert: Flag indicating whether to invert the binary image (black becomes white and vice versa). Default is True.</span>
<span class="sd">        :return np.ndarray: 4-dimensional array with black and white image.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin.read_img_batch_from_video(video_path=&#39;/Users/simon/Downloads/3A_Mouse_5-choice_MouseTouchBasic_a1.mp4&#39;, start_frm=0, end_frm=100)</span>
<span class="sd">        &gt;&gt;&gt; imgs = np.stack(imgs.values(), axis=0)</span>
<span class="sd">        &gt;&gt;&gt; bw_imgs = ImageMixin.img_stack_to_bw(imgs=imgs, upper_thresh=255, lower_thresh=20, invert=False)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span>
            <span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">img_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">total</span> <span class="o">+=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
                    <span class="n">img_mean</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">total</span> <span class="o">/</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">img_mean</span> <span class="o">&lt;</span> <span class="n">lower_thresh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img_mean</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">img</span> <span class="o">&gt;</span> <span class="n">upper_thresh</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">img</span>
            <span class="n">results</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">img</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="ImageMixin.segment_img_horizontal"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.segment_img_horizontal">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">segment_img_horizontal</span><span class="p">(</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">pct</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">lower</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">both</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Segment a horizontal part of the input image.</span>

<span class="sd">        This function segments either the lower, upper, or both lower and upper part of the input image based on the specified percentage.</span>

<span class="sd">        .. image:: _static/img/segment_img_horizontal.png</span>
<span class="sd">           :width: 800</span>
<span class="sd">           :align: center</span>

<span class="sd">        :param np.ndarray img: Input image as a NumPy array.</span>
<span class="sd">        :param int pct: Percentage of the image to be segmented. If `lower` is True, it represents the lower part; if False, it represents the upper part.</span>
<span class="sd">        :param Optional[bool] lower: Flag indicating whether to segment the lower part (True) or upper part (False) of the image. Default is True.</span>
<span class="sd">        :param Optional[bool] both: If True, **removes** both the upper pct and lower pct and keeps middle part.</span>
<span class="sd">        :return np.array: Segmented part of the image.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; img = cv2.imread(&#39;/Users/simon/Desktop/test.png&#39;)</span>
<span class="sd">        &gt;&gt;&gt; img = ImageMixin.segment_img_horizontal(img=img, pct=10, both=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_if_valid_img</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">segment_img_horizontal</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">segment_img_horizontal</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> pct&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">pct</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="mi">99</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sliced_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">both</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">img</span><span class="p">[</span><span class="n">sliced_height</span> <span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">sliced_height</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">elif</span> <span class="n">lower</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">img</span><span class="p">[</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">sliced_height</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">img</span><span class="p">[:</span><span class="n">sliced_height</span><span class="p">,</span> <span class="p">:]</span></div>

<div class="viewcode-block" id="ImageMixin.segment_img_stack_horizontal"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.segment_img_stack_horizontal">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">segment_img_stack_horizontal</span><span class="p">(</span><span class="n">imgs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">pct</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">lower</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">both</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Segment a horizontal part of all images in stack.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin.read_img_batch_from_video(video_path=&#39;/Users/simon/Downloads/3A_Mouse_5-choice_MouseTouchBasic_a1.mp4&#39;, start_frm=0, end_frm=400)</span>
<span class="sd">        &gt;&gt;&gt; imgs = np.stack(imgs.values(), axis=0)</span>
<span class="sd">        &gt;&gt;&gt; sliced_imgs = ImageMixin.segment_img_stack_horizontal(imgs=imgs, pct=50, lower=True, both=False)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cnt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span>
            <span class="n">sliced_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">both</span><span class="p">:</span>
                <span class="n">sliced_img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">sliced_height</span> <span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">sliced_height</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">elif</span> <span class="n">lower</span><span class="p">:</span>
                <span class="n">sliced_img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">sliced_height</span> <span class="p">:,</span> <span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sliced_img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:</span><span class="n">sliced_height</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sliced_img</span><span class="p">)</span>
        <span class="n">stacked_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)):</span>
            <span class="n">stacked_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="ImageMixin.segment_img_vertical"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.segment_img_vertical">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">segment_img_vertical</span><span class="p">(</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">pct</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">left</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">both</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Segment a vertical part of the input image.</span>

<span class="sd">        This function segments either the left, right or both the left and right part of  input image based on the specified percentage.</span>

<span class="sd">        .. image:: _static/img/segment_img_vertical.png</span>
<span class="sd">           :width: 800</span>
<span class="sd">           :align: center</span>

<span class="sd">        :param np.ndarray img: Input image as a NumPy array.</span>
<span class="sd">        :param int pct: Percentage of the image to be segmented. If `lower` is True, it represents the lower part; if False, it represents the upper part.</span>
<span class="sd">        :param Optional[bool] lower: Flag indicating whether to segment the lower part (True) or upper part (False) of the image. Default is True.</span>
<span class="sd">        :param Optional[bool] both: If True, **removes** both the left pct and right pct and keeps middle part.</span>
<span class="sd">        :return np.array: Segmented part of the image.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">segment_img_vertical</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">segment_img_vertical</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> pct&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">pct</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="mi">99</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sliced_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">pct</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">both</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">img</span><span class="p">[:,</span> <span class="n">sliced_width</span> <span class="p">:</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sliced_width</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">left</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:</span><span class="n">sliced_width</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">img</span><span class="p">[:,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">sliced_width</span> <span class="p">:]</span></div>

<div class="viewcode-block" id="ImageMixin.add_img_border_and_flood_fill"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.add_img_border_and_flood_fill">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_img_border_and_flood_fill</span><span class="p">(</span>
        <span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span> <span class="n">invert</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a border to the input image and perform flood fill.</span>

<span class="sd">        E.g., Used to remove any black pixel areas connected to the border of the image. Used to remove noise</span>
<span class="sd">        if noise is defined as being connected to the edges of the image.</span>

<span class="sd">        .. image:: _static/img/add_img_border_and_flood_fill.png</span>
<span class="sd">           :width: 400</span>
<span class="sd">           :align: center</span>

<span class="sd">        :param np.ndarray img: Input image as a numpy array.</span>
<span class="sd">        :param Optional[bool] invert: If false, make black border and floodfill black pixels with white. If True, make white border and floodfill white pixels with black. Default False.</span>
<span class="sd">        :param Optional[bool] size: Size of border. Default 1 pixel.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_if_valid_img</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">add_img_border_and_flood_fill</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">add_img_border_and_flood_fill</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> size&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InvalidInputError</span><span class="p">(</span>
                <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Floodfill requires 2d image&quot;</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">add_img_border_and_flood_fill</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">invert</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">copyMakeBorder</span><span class="p">(</span>
                <span class="n">img</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">floodFill</span><span class="p">(</span>
                <span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">seedPoint</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">newVal</span><span class="o">=</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
            <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">copyMakeBorder</span><span class="p">(</span>
                <span class="n">img</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">BORDER_CONSTANT</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">255</span>
            <span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">floodFill</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">,</span> <span class="n">seedPoint</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">newVal</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">img</span><span class="p">[</span><span class="n">size</span><span class="p">:</span><span class="o">-</span><span class="n">size</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span><span class="o">-</span><span class="n">size</span><span class="p">]</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_image_reader_helper</span><span class="p">(</span><span class="n">img_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Multiprocessing helper for ``ImageMixin().read_all_img_in_dir``&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">img_path</span> <span class="ow">in</span> <span class="n">img_paths</span><span class="p">:</span>
            <span class="n">results</span><span class="p">[</span><span class="n">get_fn_ext</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">img_path</span><span class="p">)[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>

<div class="viewcode-block" id="ImageMixin.read_all_img_in_dir"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.read_all_img_in_dir">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_all_img_in_dir</span><span class="p">(</span><span class="nb">dir</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="n">core_cnt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper to read in all images within a directory using multiprocessing.</span>
<span class="sd">        Returns a dictionary with the image name as key and the images in array format as values.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin().read_all_img_in_dir(dir=&#39;/Users/simon/Desktop/envs/troubleshooting/two_black_animals_14bp/project_folder/Together_4_cropped_frames&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_if_dir_exists</span><span class="p">(</span><span class="n">in_dir</span><span class="o">=</span><span class="nb">dir</span><span class="p">)</span>
        <span class="n">file_paths</span> <span class="o">=</span> <span class="n">find_files_of_filetypes_in_directory</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="nb">dir</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">Options</span><span class="o">.</span><span class="n">ALL_IMAGE_FORMAT_OPTIONS</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">raise_error</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">core_cnt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">core_cnt</span> <span class="o">=</span> <span class="n">find_core_cnt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_paths</span><span class="p">)</span> <span class="o">//</span> <span class="n">core_cnt</span>
        <span class="n">file_paths</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">file_paths</span><span class="p">[</span>
                <span class="n">i</span> <span class="o">*</span> <span class="n">chunk_size</span>
                <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_paths</span><span class="p">)</span> <span class="o">%</span> <span class="n">core_cnt</span><span class="p">)</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">chunk_size</span>
                <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_paths</span><span class="p">)</span> <span class="o">%</span> <span class="n">core_cnt</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">core_cnt</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span>
            <span class="n">core_cnt</span><span class="p">,</span> <span class="n">maxtasksperchild</span><span class="o">=</span><span class="n">Defaults</span><span class="o">.</span><span class="n">LARGE_MAX_TASK_PER_CHILD</span><span class="o">.</span><span class="n">value</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">_image_reader_helper</span><span class="p">,</span> <span class="n">file_paths</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">imgs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">imgs</span></div>

<div class="viewcode-block" id="ImageMixin.img_stack_mse"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.img_stack_mse">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">([(</span><span class="n">uint8</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">uint8</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:]),</span> <span class="p">(</span><span class="n">uint8</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">uint8</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:])])</span>
    <span class="k">def</span> <span class="nf">img_stack_mse</span><span class="p">(</span><span class="n">imgs_1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">imgs_2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pairwise comparison of images in two stacks of equal length using mean squared errors.</span>

<span class="sd">        .. note::</span>
<span class="sd">           Useful for noting subtle changes, each imgs_2 equals imgs_1 with images shifted by 1. Images has to be in uint8 format.</span>
<span class="sd">           Also see ``img_sliding_mse``.</span>


<span class="sd">        :param np.ndarray imgs_1: First three (non-color) or four (color) dimensional stack of images in array format.</span>
<span class="sd">        :param np.ndarray imgs_1: Second three (non-color) or four (color) dimensional stack of images in array format.</span>
<span class="sd">        :return np.ndarray: Array of size len(imgs_1) comparing ``imgs_1`` and ``imgs_2`` at each index using mean squared errors at each pixel location.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; img_1 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/0.png&#39;).astype(np.uint8)</span>
<span class="sd">        &gt;&gt;&gt; img_2 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/10.png&#39;).astype(np.uint8)</span>
<span class="sd">        &gt;&gt;&gt; imgs_1 = np.stack((img_1, img_2)); imgs_2 = np.stack((img_2, img_2))</span>
<span class="sd">        &gt;&gt;&gt; ImageMixin.img_stack_mse(imgs_1=imgs_1, imgs_2=imgs_2)</span>
<span class="sd">        &gt;&gt;&gt; [637,   0]</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin().read_all_img_in_dir(dir=&#39;/Users/simon/Desktop/envs/troubleshooting/two_black_animals_14bp/project_folder/Together_4_cropped_frames&#39;)</span>
<span class="sd">        &gt;&gt;&gt; imgs_1 = np.stack(imgs.values())</span>
<span class="sd">        &gt;&gt;&gt; imgs_2 = np.roll(imgs_1,-1, axis=0)</span>
<span class="sd">        &gt;&gt;&gt; mse = ImageMixin().img_stack_mse(imgs_1=imgs_1, imgs_2=imgs_1)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">imgs_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imgs_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">imgs_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">imgs_2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">imgs_1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">imgs_2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span></div>

<div class="viewcode-block" id="ImageMixin.img_sliding_mse"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.img_sliding_mse">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">([(</span><span class="n">uint8</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">int64</span><span class="p">),</span> <span class="p">(</span><span class="n">uint8</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="n">int64</span><span class="p">)])</span>
    <span class="k">def</span> <span class="nf">img_sliding_mse</span><span class="p">(</span><span class="n">imgs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">slide_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the mean squared error (MSE) between pairs of images in a sliding window manner.</span>

<span class="sd">        This function performs pairwise comparisons of images using mean squared errors (MSE).</span>
<span class="sd">        It slides a window of the specified size over the sequence of images and computes the MSE</span>
<span class="sd">        between each image and the image that is `slide_size` positions before it.</span>


<span class="sd">        .. image:: _static/img/img_sliding_mse.webp</span>
<span class="sd">           :width: 600</span>
<span class="sd">           :align: center</span>

<span class="sd">        :param imgs: 3d or 4d A numpy array of images.</span>
<span class="sd">        :param slide_size: The size of the sliding window (default is 1).</span>
<span class="sd">        :return: A numpy array of MSE values for each pair of images in the sliding window.</span>


<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin().read_all_img_in_dir(dir=&#39;/Users/simon/Desktop/envs/troubleshooting/two_black_animals_14bp/project_folder/Together_4_cropped_frames&#39;)</span>
<span class="sd">        &gt;&gt;&gt; imgs = np.stack(imgs.values())</span>
<span class="sd">        &gt;&gt;&gt; mse = ImageMixin().img_sliding_mse(imgs=imgs, slide_size=2)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">slide_size</span><span class="p">,</span> <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">slide_size</span><span class="p">]</span> <span class="o">-</span> <span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">slide_size</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">int64</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_read_img_batch_from_video_helper</span><span class="p">(</span>
        <span class="n">frm_idx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">video_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Multiprocess helper used by read_img_batch_from_video to read in images from video file.&quot;&quot;&quot;</span>
        <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_frm</span><span class="p">,</span> <span class="n">current_frm</span> <span class="o">=</span> <span class="n">frm_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">frm_idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">frm_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>
        <span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">current_frm</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">current_frm</span> <span class="o">&lt;</span> <span class="n">end_frm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reading frame idx </span><span class="si">{</span><span class="n">current_frm</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="n">current_frm</span><span class="p">]</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">current_frm</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">results</span>

<div class="viewcode-block" id="ImageMixin.read_img_batch_from_video"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.read_img_batch_from_video">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read_img_batch_from_video</span><span class="p">(</span>
        <span class="n">video_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span>
        <span class="n">start_frm</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">end_frm</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">core_cnt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read a batch of frames from a video file. This method reads frames from a specified range of frames within a video file using multiprocessing.</span>

<span class="sd">        :param Union[str, os.PathLike] video_path: Path to the video file.</span>
<span class="sd">        :param int start_frm: Starting frame index.</span>
<span class="sd">        :param int end_frm: Ending frame index.</span>
<span class="sd">        :param Optionalint] core_cnt: Number of CPU cores to use for parallel processing. Default is -1, indicating using all available cores.</span>
<span class="sd">        :param Optional[bool] greyscale: If True, reads the images as greyscale. If False, then as original color scale. Default: True.</span>
<span class="sd">        :returns Dict[int, np.ndarray]: A dictionary containing frame indices as keys and corresponding frame arrays as values.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; ImageMixin().read_img_batch_from_video(video_path=&#39;/Users/simon/Desktop/envs/troubleshooting/two_black_animals_14bp/videos/Together_1.avi&#39;, start_frm=0, end_frm=50)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_file_exist_and_readable</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">video_path</span><span class="p">)</span>
        <span class="n">video_meta_data</span> <span class="o">=</span> <span class="n">get_video_meta_data</span><span class="p">(</span><span class="n">video_path</span><span class="o">=</span><span class="n">video_path</span><span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">start_frm</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="n">video_meta_data</span><span class="p">[</span><span class="s2">&quot;frame_count&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">end_frm</span><span class="p">,</span>
            <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">max_value</span><span class="o">=</span><span class="n">video_meta_data</span><span class="p">[</span><span class="s2">&quot;frame_count&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">core_cnt</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">core_cnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">core_cnt</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">end_frm</span> <span class="o">&lt;=</span> <span class="n">start_frm</span><span class="p">:</span>
            <span class="n">FrameRangeError</span><span class="p">(</span>
                <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Start frame (</span><span class="si">{</span><span class="n">start_frm</span><span class="si">}</span><span class="s2">) has to be before end frame (</span><span class="si">{</span><span class="n">end_frm</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">frm_lst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_frm</span><span class="p">,</span> <span class="n">end_frm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">core_cnt</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span>
            <span class="n">core_cnt</span><span class="p">,</span> <span class="n">maxtasksperchild</span><span class="o">=</span><span class="n">Defaults</span><span class="o">.</span><span class="n">LARGE_MAX_TASK_PER_CHILD</span><span class="o">.</span><span class="n">value</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">constants</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
                <span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">_read_img_batch_from_video_helper</span><span class="p">,</span> <span class="n">video_path</span><span class="o">=</span><span class="n">video_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">constants</span><span class="p">,</span> <span class="n">frm_lst</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">)):</span>
                <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="ImageMixin.img_emd"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.img_emd">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">img_emd</span><span class="p">(</span><span class="n">imgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">img_1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">img_2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">lower_bound</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Wasserstein distance between two images represented as numpy arrays.</span>

<span class="sd">        .. note::</span>
<span class="sd">           Long runtime for larger images. Consider down-sampling videos / images before caluclating wasserstein / earth mover distances.</span>

<span class="sd">        .. image:: _static/img/img_emd.webp</span>
<span class="sd">           :width: 600</span>
<span class="sd">           :align: center</span>


<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; img_1 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/Emergence/project_folder/videos/Example_1_frames/24.png&#39;, 0).astype(np.float32)</span>
<span class="sd">        &gt;&gt;&gt; img_2 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/Emergence/project_folder/videos/Example_1_frames/1984.png&#39;, 0).astype(np.float32)</span>
<span class="sd">        &gt;&gt;&gt; ImageMixin.img_emd(img_1=img_1, img_2=img_2, lower_bound=0.5)</span>
<span class="sd">        &gt;&gt;&gt; 10.658767700195312</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="n">SimbaTimer</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">check_float</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">img_emd</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> lower bound&quot;</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">img_1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">img_1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">imgs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">img_1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">img_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidInputError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Pass img_1 and img_2 OR imgs&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">img_1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">img_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">img_1</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">img_emd</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">img_2</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">img_emd</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">img_1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">img_1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img_1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">img_2</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">img_2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img_2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">check_valid_lst</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">imgs</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">img_emd</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">valid_dtypes</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,),</span> <span class="n">exact_len</span><span class="o">=</span><span class="mi">2</span><span class="p">,)</span>
            <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">img_emd</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">imgs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">img_emd</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">img_1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">imgs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">img_2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">stop_timer</span><span class="p">()</span>
        <span class="n">emd</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">EMD</span><span class="p">(</span><span class="n">img_1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">img_2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">cv2</span><span class="o">.</span><span class="n">DIST_L2</span><span class="p">,</span> <span class="n">lowerBound</span><span class="o">=</span><span class="n">lower_bound</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">stdout_success</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;EMD complete&#39;</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="o">=</span><span class="n">timer</span><span class="o">.</span><span class="n">elapsed_time_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">emd</span></div>

<div class="viewcode-block" id="ImageMixin.create_uniform_img"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.create_uniform_img">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_uniform_img</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
                           <span class="n">color</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
                           <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an image of specified size and color, and optionally saves it to a file.</span>

<span class="sd">        .. image:: _static/img/create_uniform_img.webp</span>
<span class="sd">           :width: 600</span>
<span class="sd">           :align: center</span>

<span class="sd">        :param Tuple[int, int] size: A tuple of two integers representing the width and height of the image.</span>
<span class="sd">        :param Tuple[int, int, int] color: A tuple of three integers representing the RGB color (e.g., (255, 0, 0) for red).</span>
<span class="sd">        :param Optional[Union[str, os.PathLike]] save_path: a string representing the file path to save the image.  If not provided, the function returns the image as a numpy array.</span>
<span class="sd">        :return Union[None, np.ndarray]: If save_path is provided, the function saves the image to the specified path and returns None. f save_path is not provided, the function returns the image as a numpy ndarray.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; from simba.utils.data import create_color_palette</span>
<span class="sd">        &gt;&gt;&gt; clrs = create_color_palette(pallete_name=&#39;inferno&#39;, increments=4, as_int=True)</span>
<span class="sd">        &gt;&gt;&gt; imgs_stack = np.full((5, 10, 10, 3), -1)</span>
<span class="sd">        &gt;&gt;&gt; for cnt, i in enumerate(clrs): imgs_stack[cnt] = ImageMixin.create_uniform_img(size=(10, 10), color=tuple(i))</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_valid_tuple</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">accepted_lengths</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="n">valid_dtypes</span><span class="o">=</span><span class="p">(</span><span class="nb">int</span><span class="p">,))</span>
        <span class="n">check_if_valid_rgb_tuple</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">img</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">color</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">check_if_dir_exists</span><span class="p">(</span><span class="n">in_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_path</span><span class="p">))</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">img</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">img</span></div>

<div class="viewcode-block" id="ImageMixin.img_matrix_mse"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.img_matrix_mse">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">img_matrix_mse</span><span class="p">(</span><span class="n">imgs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the mean squared error (MSE) matrix table for a stack of images.</span>

<span class="sd">        This function calculates the MSE between each pair of images in the input array</span>
<span class="sd">        and returns a symmetric matrix where each element (i, j) represents the MSE</span>
<span class="sd">        between the i-th and j-th images. Useful for image similarities and anomalities.</span>

<span class="sd">        .. image:: _static/img/img_matrix_mse.webp</span>
<span class="sd">           :width: 600</span>
<span class="sd">           :align: center</span>

<span class="sd">        :param np.ndarray imgs: A stack of images represented as a numpy array.</span>
<span class="sd">        :return np.ndarray: The MSE matrix table.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin().read_img_batch_from_video(video_path=&#39;/Users/simon/Desktop/envs/troubleshooting/two_black_animals_14bp/videos/Together_1.avi&#39;, start_frm=0, end_frm=50)</span>
<span class="sd">        &gt;&gt;&gt; imgs = np.stack(list(imgs.values()))</span>
<span class="sd">        &gt;&gt;&gt; ImageMixin().img_matrix_mse(imgs=imgs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">imgs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">imgs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span></div>

<div class="viewcode-block" id="ImageMixin.img_to_greyscale"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.img_to_greyscale">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">img_to_greyscale</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a single color image to greyscale.</span>

<span class="sd">        The function takes an RGB image and converts it to a greyscale image using a weighted sum approach.</span>
<span class="sd">        If the input image is already in greyscale (2D array), it is returned as is.</span>

<span class="sd">        :param np.ndarray img: Input image represented as a NumPy array. For a color image, the array should have three channels (RGB).</span>
<span class="sd">        :return np.ndarray: The greyscale image as a 2D NumPy array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">img_to_greyscale</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="mf">0.07</span> <span class="o">*</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.72</span> <span class="o">*</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.21</span> <span class="o">*</span> <span class="n">img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span></div>

<div class="viewcode-block" id="ImageMixin.img_stack_to_greyscale"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.img_stack_to_greyscale">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">(</span><span class="s2">&quot;(uint8[:, :, :, :],)&quot;</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">img_stack_to_greyscale</span><span class="p">(</span><span class="n">imgs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Jitted conversion of a 4D stack of color images (RGB format) to grayscale.</span>

<span class="sd">        .. image:: _static/img/img_stack_to_greyscale.png</span>
<span class="sd">           :width: 600</span>
<span class="sd">           :align: center</span>

<span class="sd">        :parameter np.ndarray imgs: A 4D array representing color images. It should have the shape (num_images, height, width, 3) where the last dimension represents the color channels (R, G, B).</span>
<span class="sd">        :returns np.ndarray: A 3D array containing the grayscale versions of the input images. The shape of the output array is (num_images, height, width).</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin().read_img_batch_from_video( video_path=&#39;/Users/simon/Desktop/envs/troubleshooting/two_black_animals_14bp/videos/Together_1.avi&#39;, start_frm=0, end_frm=100)</span>
<span class="sd">        &gt;&gt;&gt; imgs = np.stack(list(imgs.values()))</span>
<span class="sd">        &gt;&gt;&gt; imgs_gray = ImageMixin.img_stack_to_greyscale(imgs=imgs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">vals</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.07</span> <span class="o">*</span> <span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.72</span> <span class="o">*</span> <span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.21</span> <span class="o">*</span> <span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_slice_shapes_in_imgs_array_helper</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private multiprocess helper called from ``simba.mixins.image_mixin.ImageMixins.slice_shapes_in_imgs()`` to slice shapes from</span>
<span class="sd">        an array of images.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img</span><span class="p">,</span> <span class="n">in_shapes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">shapes</span><span class="p">,</span> <span class="n">results</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">shape</span> <span class="ow">in</span> <span class="n">in_shapes</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shape</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="n">shape</span><span class="p">[</span><span class="n">shape</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">shapes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">shape_cnt</span><span class="p">,</span> <span class="n">shape</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">shapes</span><span class="p">):</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">roi_img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">roi_img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">[</span><span class="n">shape</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">roi_img</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">results</span>

<div class="viewcode-block" id="ImageMixin.pad_img_stack"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.pad_img_stack">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">pad_img_stack</span><span class="p">(</span><span class="n">image_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">pad_value</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pad images in a dictionary stack to have the same dimensions (the same dimension is represented by the largest image in the stack)</span>

<span class="sd">        .. image:: _static/img/pad_img_stack.webp</span>
<span class="sd">           :width: 400</span>
<span class="sd">           :align: center</span>

<span class="sd">        :param Dict[int, np.ndarray] image_dict: A dictionary mapping integer keys to numpy arrays representing images.</span>
<span class="sd">        :param Optional[int] pad_value: The value (between 0-255) used for padding. Defaults to 0 (black)</span>
<span class="sd">        :return Dict[int, np.ndarray]: A dictionary mapping integer keys to numpy arrays representing padded images.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_instance</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">pad_img_stack</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">image_dict</span><span class="p">,</span><span class="n">accepted_types</span><span class="o">=</span><span class="p">(</span><span class="nb">dict</span><span class="p">,))</span>
        <span class="n">check_int</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">pad_img_stack</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> pad_value&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">pad_value</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">max_height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">image_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">max_width</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">image_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">padded_images</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">image_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pad_height</span> <span class="o">=</span> <span class="n">max_height</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pad_width</span> <span class="o">=</span> <span class="n">max_width</span> <span class="o">-</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">padded_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_height</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="n">pad_value</span><span class="p">)</span>
            <span class="n">padded_images</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">padded_image</span>
        <span class="k">return</span> <span class="n">padded_images</span></div>

<div class="viewcode-block" id="ImageMixin.img_stack_to_video"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.img_stack_to_video">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">img_stack_to_video</span><span class="p">(</span><span class="n">imgs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                           <span class="n">fps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                           <span class="n">save_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span>
                           <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a dictionary of images into a video file.</span>

<span class="sd">        .. note::</span>
<span class="sd">           The input dictionary ``imgs`` can be created with ``simba.mixins.ImageMixin.slice_shapes_in_imgs``.</span>

<span class="sd">        :param Dict[int, np.ndarray] imgs: A dictionary containing frames of the video, where the keys represent frame indices and the values are numpy arrays representing the images.</span>
<span class="sd">        :param Union[str, os.PathLike] save_path: The path to save the output video file.</span>
<span class="sd">        :param int fps: Frames per second (FPS) of the output video.</span>
<span class="sd">        :param Optional[bool] verbose: If True, prints progress messages. Defaults to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">timer</span> <span class="o">=</span> <span class="n">SimbaTimer</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">check_instance</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">img_stack_to_video</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">imgs</span><span class="p">,</span> <span class="n">accepted_types</span><span class="o">=</span><span class="p">(</span><span class="nb">dict</span><span class="p">,))</span>
        <span class="n">img_sizes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">imgs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">img_sizes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">img_sizes</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">imgs</span> <span class="o">=</span> <span class="n">ImageMixin</span><span class="o">.</span><span class="n">pad_img_stack</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">fourcc</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter_fourcc</span><span class="p">(</span><span class="o">*</span><span class="n">Formats</span><span class="o">.</span><span class="n">MP4_CODEC</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoWriter</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">fourcc</span><span class="p">,</span> <span class="n">fps</span><span class="p">,</span> <span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Writing img </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">stop_timer</span><span class="p">()</span>
        <span class="n">stdout_success</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Video </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2"> complete&quot;</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="o">=</span><span class="n">timer</span><span class="o">.</span><span class="n">elapsed_time_str</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_slice_shapes_in_video_file_helper</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                           <span class="n">video_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span>
                                           <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>

        <span class="n">cap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">(</span><span class="n">video_path</span><span class="p">)</span>
        <span class="n">start_frm</span><span class="p">,</span> <span class="n">current_frm</span><span class="p">,</span> <span class="n">end_frm</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cap</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">start_frm</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">idx_cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">current_frm</span> <span class="o">&lt;=</span> <span class="n">end_frm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing frame </span><span class="si">{</span><span class="n">current_frm</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">cap</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">current_frm</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">idx_cnt</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="n">shape</span><span class="p">[</span><span class="n">shape</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">boundingRect</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">roi_img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">y</span> <span class="p">:</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span> <span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">roi_img</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">cv2</span><span class="o">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">[</span><span class="n">shape</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">LINE_AA</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="n">current_frm</span><span class="p">]</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">bitwise_and</span><span class="p">(</span><span class="n">roi_img</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">current_frm</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">idx_cnt</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">results</span>

<div class="viewcode-block" id="ImageMixin.slice_shapes_in_imgs"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.slice_shapes_in_imgs">[docs]</a>    <span class="k">def</span> <span class="nf">slice_shapes_in_imgs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">imgs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span>
                             <span class="n">shapes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Polygon</span><span class="p">]],</span>
                             <span class="n">core_cnt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Slice regions from a stack of images or a video file, where the regions are based on defined shapes. Uses multiprocessing.</span>

<span class="sd">        For example, given a stack of N images, and N*X geometries representing the region around the animal body-part(s),</span>
<span class="sd">        slice out the X geometries from each of the N images and return the sliced areas.</span>

<span class="sd">        .. image:: _static/img/slice_shapes_in_imgs_4.gif</span>
<span class="sd">           :width: 400</span>
<span class="sd">           :align: center</span>

<span class="sd">        .. image:: _static/img/bodyparts_to_circle_1.gif</span>
<span class="sd">           :width: 400</span>
<span class="sd">           :align: center</span>

<span class="sd">        .. image:: _static/img/bodyparts_to_circle_2.gif</span>
<span class="sd">           :width: 400</span>
<span class="sd">           :align: center</span>

<span class="sd">        :example I:</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin().read_img_batch_from_video(video_path=&#39;/Users/simon/Desktop/envs/troubleshooting/Emergence/project_folder/videos/Example_1.mp4&#39;, start_frm=0, end_frm=10)</span>
<span class="sd">        &gt;&gt;&gt; imgs = np.stack(list(imgs.values()))</span>
<span class="sd">        &gt;&gt;&gt; imgs_gray = ImageMixin().img_stack_to_greyscale(imgs=imgs)</span>
<span class="sd">        &gt;&gt;&gt; data = pd.read_csv(&#39;/Users/simon/Desktop/envs/troubleshooting/Emergence/project_folder/csv/outlier_corrected_movement_location/Example_1.csv&#39;, nrows=11).fillna(-1)</span>
<span class="sd">        &gt;&gt;&gt; nose_array, tail_array = data.loc[0:10, [&#39;Nose_x&#39;, &#39;Nose_y&#39;]].values.astype(np.float32), data.loc[0:10, [&#39;Tail_base_x&#39;, &#39;Tail_base_y&#39;]].values.astype(np.float32)</span>
<span class="sd">        &gt;&gt;&gt; nose_shapes, tail_shapes = [], []</span>
<span class="sd">        &gt;&gt;&gt; for frm_data in nose_array: nose_shapes.append(GeometryMixin().bodyparts_to_circle(frm_data, 80))</span>
<span class="sd">        &gt;&gt;&gt; for frm_data in tail_array: tail_shapes.append(GeometryMixin().bodyparts_to_circle(frm_data, 80))</span>
<span class="sd">        &gt;&gt;&gt; shapes = np.array(np.vstack([nose_shapes, tail_shapes]).T)</span>
<span class="sd">        &gt;&gt;&gt; sliced_images = ImageMixin().slice_shapes_in_imgs(imgs=imgs_gray, shapes=shapes)</span>

<span class="sd">        :example II:</span>
<span class="sd">        &gt;&gt;&gt; video_path = &#39;/Users/simon/Desktop/envs/troubleshooting/Emergence/project_folder/videos/Example_1_clipped.mp4&#39;</span>
<span class="sd">        &gt;&gt;&gt; data_path = r&#39;/Users/simon/Desktop/envs/troubleshooting/Emergence/project_folder/csv/outlier_corrected_movement_location/Example_1_clipped.csv&#39;</span>
<span class="sd">        &gt;&gt;&gt; df = pd.read_csv(data_path, usecols=[&#39;Nose_x&#39;, &#39;Nose_y&#39;, &#39;Tail_base_x&#39;, &#39;Tail_base_y&#39;]).fillna(0).values.astype(int)</span>
<span class="sd">        &gt;&gt;&gt; data = df.reshape(len(df), -1, int(df.shape[1]/2))</span>
<span class="sd">        &gt;&gt;&gt; geometries = GeometryMixin().multiframe_bodyparts_to_line(data=data, buffer=30, px_per_mm=4.1)</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin().slice_shapes_in_imgs(imgs=video_path, shapes=geometries)</span>


<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timer</span> <span class="o">=</span> <span class="n">SimbaTimer</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">slice_shapes_in_imgs</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> core count&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">core_cnt</span><span class="p">,</span><span class="n">min_value</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">core_cnt</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">core_cnt</span> <span class="o">=</span> <span class="n">find_core_cnt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">check_instance</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">slice_shapes_in_imgs</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">imgs</span><span class="p">,</span> <span class="n">accepted_types</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">str</span><span class="p">))</span>
        <span class="n">check_instance</span><span class="p">(</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">slice_shapes_in_imgs</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">shapes</span><span class="p">,</span> <span class="n">accepted_types</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">check_valid_array</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">shapes</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">slice_shapes_in_imgs</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">accepted_ndims</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="n">accepted_dtypes</span><span class="o">=</span><span class="p">[</span><span class="n">Polygon</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">check_valid_lst</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">shapes</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">slice_shapes_in_imgs</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">valid_dtypes</span><span class="o">=</span><span class="p">[</span><span class="n">Polygon</span><span class="p">])</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">check_valid_array</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">imgs</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">slice_shapes_in_imgs</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">accepted_ndims</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">shapes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">ArrayError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;The image array (</span><span class="si">{</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">) and shapes array (</span><span class="si">{</span><span class="n">shapes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">) have unequal length.&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">slice_shapes_in_imgs</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">check_file_exist_and_readable</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">imgs</span><span class="p">)</span>
            <span class="n">video_meta_data</span> <span class="o">=</span> <span class="n">get_video_meta_data</span><span class="p">(</span><span class="n">video_path</span><span class="o">=</span><span class="n">imgs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">shapes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">video_meta_data</span><span class="p">[</span><span class="s2">&quot;frame_count&quot;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">ArrayError</span><span class="p">(</span> <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;The image array (</span><span class="si">{</span><span class="n">video_meta_data</span><span class="p">[</span><span class="s2">&quot;frame_count&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">) and shapes array (</span><span class="si">{</span><span class="n">shapes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">) have unequal length.&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="p">()</span><span class="o">.</span><span class="n">slice_shapes_in_imgs</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">result_lst</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">core_cnt</span><span class="p">,</span> <span class="n">maxtasksperchild</span><span class="o">=</span><span class="n">Defaults</span><span class="o">.</span><span class="n">LARGE_MAX_TASK_PER_CHILD</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_slice_shapes_in_imgs_array_helper</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">shapes</span><span class="p">),</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">)):</span>
                    <span class="n">result_lst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result_lst</span><span class="p">):</span>
                <span class="n">results</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">shapes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">)),</span> <span class="n">shapes</span><span class="p">)),</span> <span class="n">core_cnt</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">core_cnt</span><span class="p">,</span> <span class="n">maxtasksperchild</span><span class="o">=</span><span class="n">Defaults</span><span class="o">.</span><span class="n">LARGE_MAX_TASK_PER_CHILD</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">constants</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">_slice_shapes_in_video_file_helper</span><span class="p">,</span> <span class="n">video_path</span><span class="o">=</span><span class="n">imgs</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">constants</span><span class="p">,</span> <span class="n">shapes</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">)):</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ChainMap</span><span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">))</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">stop_timer</span><span class="p">()</span>
        <span class="n">stdout_success</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Geometry image slicing complete.&quot;</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="o">=</span><span class="n">timer</span><span class="o">.</span><span class="n">elapsed_time_str</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="ImageMixin.structural_similarity_index"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.structural_similarity_index">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">structural_similarity_index</span><span class="p">(</span><span class="n">img_1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">img_2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the Structural Similarity Index (SSI) between two images.</span>

<span class="sd">        The function evaluates the SSI between two input images `img_1` and `img_2`. If the images have different numbers</span>
<span class="sd">        of channels, they are converted to greyscale before computing the SSI. If the images are multi-channel (e.g., RGB),</span>
<span class="sd">        the SSI is computed for each channel.</span>

<span class="sd">        .. seealso::</span>
<span class="sd">           ``simba.mixins.image_mixin.ImageMixin.structural_similarity_matrix``</span>
<span class="sd">           ``simba.mixins.image_mixin.ImageMixin.sliding_structural_similarity_index``</span>

<span class="sd">        :param np.ndarray img_1: The first input image represented as a NumPy array.</span>
<span class="sd">        :param np.ndarray img_2: The second input image represented as a NumPy array.</span>
<span class="sd">        :return float: The SSI value representing the similarity between the two images.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">img_1</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">structural_similarity_index</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> img_1&#39;</span><span class="p">)</span>
        <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">img_2</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">structural_similarity_index</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> img_2&#39;</span><span class="p">)</span>
        <span class="n">multichannel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">img_1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="n">img_2</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="n">img_1</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img_1</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
            <span class="n">img_2</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img_2</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">img_1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span> <span class="n">multichannel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">structural_similarity</span><span class="p">(</span><span class="n">im1</span><span class="o">=</span><span class="n">img_1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">im2</span><span class="o">=</span><span class="n">img_2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">),</span> <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">))</span></div>

<div class="viewcode-block" id="ImageMixin.sliding_structural_similarity_index"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.sliding_structural_similarity_index">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">sliding_structural_similarity_index</span><span class="p">(</span><span class="n">imgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                                            <span class="n">stride</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                                            <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the Structural Similarity Index (SSI) between consecutive images in an array with a specified stride.</span>

<span class="sd">        The function evaluates the SSI between pairs of images in the input array `imgs` using a sliding window approach</span>
<span class="sd">        with the specified `stride`. The SSI is computed for each pair of images and the results are stored in an output</span>
<span class="sd">        array. If the images are multi-channel (e.g., RGB), the SSI is computed for each channel.</span>

<span class="sd">        High SSI values (close to 1) indicate high similarity between images, while low SSI values (close to 0 or negative)</span>
<span class="sd">        indicate low similarity.</span>

<span class="sd">        .. seealso::</span>
<span class="sd">           ``simba.mixins.image_mixin.ImageMixin.structural_similarity_matrix``</span>
<span class="sd">           ``simba.mixins.image_mixin.ImageMixin.structural_similarity_index``</span>

<span class="sd">        :param np.ndarray imgs: A list of images. Each element in the list is expected to be a numpy array representing an image.</span>
<span class="sd">        :param Optional[int] stride: The number of images to skip between comparisons. Default is 1.</span>
<span class="sd">        :param Optional[bool] verbose: If True, prints progress messages. Default is False.</span>
<span class="sd">        :return np.ndarray: A numpy array containing the SSI values for each pair of images.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin.read_all_img_in_dir(dir=&#39;/Users/simon/Desktop/envs/simba/troubleshooting/RAT_NOR/project_folder/videos/examples/test&#39;)</span>
<span class="sd">        &gt;&gt;&gt; imgs = {k: imgs[k] for k in sorted(imgs, key=lambda x: int(x.split(&#39;.&#39;)[0]))}</span>
<span class="sd">        &gt;&gt;&gt; imgs = list(imgs.values())</span>
<span class="sd">        &gt;&gt;&gt; results = ImageMixin.sliding_structural_similarity_index(imgs=imgs, stride=1, verbose=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_valid_lst</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">imgs</span><span class="p">,</span> <span class="n">valid_dtypes</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,),</span> <span class="n">min_len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">sliding_structural_similarity_index</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> stride&#39;</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="n">stride</span><span class="p">)</span>
        <span class="n">ndims</span><span class="p">,</span> <span class="n">multichannel</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">:</span>
            <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">sliding_structural_similarity_index</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">ndims</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ndims</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">imgs</span> <span class="o">=</span> <span class="n">ImageMixin</span><span class="o">.</span><span class="n">img_stack_to_greyscale</span><span class="p">(</span><span class="n">imgs</span><span class="o">=</span><span class="n">imgs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span> <span class="n">multichannel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">stride</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">))):</span>
            <span class="n">img_1</span><span class="p">,</span> <span class="n">img_2</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">stride</span><span class="p">],</span> <span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">structural_similarity</span><span class="p">(</span><span class="n">im1</span><span class="o">=</span><span class="n">img_1</span><span class="p">,</span> <span class="n">im2</span><span class="o">=</span><span class="n">img_2</span><span class="p">,</span> <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SSI computed (</span><span class="si">{</span><span class="n">cnt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">stride</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="ImageMixin.structural_similarity_matrix"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.structural_similarity_matrix">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">structural_similarity_matrix</span><span class="p">(</span><span class="n">imgs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">],</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes a matrix of Structural Similarity Index (SSI) values for a list of images.</span>

<span class="sd">        This function takes a list of images and computes the SSI between each pair of images and produce a symmetric matrix.</span>

<span class="sd">        .. seealso::</span>
<span class="sd">           ``simba.mixins.image_mixin.ImageMixin.sliding_structural_similarity_index``</span>
<span class="sd">           ``simba.mixins.image_mixin.ImageMixin.structural_similarity_index``</span>


<span class="sd">        :param List[np.array] imgs: A list of images represented as numpy arrays. If not all images are greyscale or color, they are converted and processed as greyscale.</span>
<span class="sd">        :param Optional[bool] verbose: If True, prints progress messages showing which SSI values have been computed.  Default is False.</span>
<span class="sd">        :return np.array: A square numpy array where the element at [i, j] represents the SSI between imgs[i] and imgs[j].</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin.read_all_img_in_dir(dir=&#39;/Users/simon/Desktop/envs/simba/troubleshooting/RAT_NOR/project_folder/videos/examples/test&#39;)</span>
<span class="sd">        &gt;&gt;&gt; imgs = {k: imgs[k] for k in sorted(imgs, key=lambda x: int(x.split(&#39;.&#39;)[0]))}</span>
<span class="sd">        &gt;&gt;&gt; imgs = list(imgs.values())[0:10]</span>
<span class="sd">        &gt;&gt;&gt; results = ImageMixin.structural_similarity_matrix(imgs=imgs)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_valid_lst</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">imgs</span><span class="p">,</span> <span class="n">valid_dtypes</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,),</span> <span class="n">min_len</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ndims</span><span class="p">,</span> <span class="n">multichannel</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">imgs</span><span class="p">:</span>
            <span class="n">check_if_valid_img</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">structural_similarity_matrix</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">ndims</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ndims</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">imgs</span> <span class="o">=</span> <span class="n">ImageMixin</span><span class="o">.</span><span class="n">img_stack_to_greyscale</span><span class="p">(</span><span class="n">imgs</span><span class="o">=</span><span class="n">imgs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">imgs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span> <span class="n">multichannel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">imgs</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SSI matrix position (</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">) complete...&#39;</span><span class="p">)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">structural_similarity</span><span class="p">(</span><span class="n">im1</span><span class="o">=</span><span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">im2</span><span class="o">=</span><span class="n">imgs</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">multichannel</span><span class="o">=</span><span class="n">multichannel</span><span class="p">)</span>
                <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="ImageMixin.cross_correlation_similarity"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.cross_correlation_similarity">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">([</span><span class="s2">&quot;(uint8[:, :], uint8[:, :])&quot;</span><span class="p">,</span>
           <span class="s2">&quot;(uint8[:, :, :], uint8[:, :, :])&quot;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">cross_correlation_similarity</span><span class="p">(</span><span class="n">img_1</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">img_2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the Normalized Cross-Correlation (NCC) similarity between two images.</span>

<span class="sd">        The NCC measures the similarity between two images by calculating the correlation</span>
<span class="sd">        coefficient of their pixel values. The output value ranges from -1 to 1, where 1 indicates perfect positive correlation, 0 indicates no correlation, and -1 indicates perfect negative correlation.</span>

<span class="sd">        :param np.ndarray img_1: The first input image. It can be a 2D grayscale image or a 3D color image.</span>
<span class="sd">        :param np.ndarray img_2:  The second input image. It must have the same dimensions as img_1.</span>
<span class="sd">        :return float: The NCC value representing the similarity between the two images. Returns 0.0 if the denominator is zero, indicating no similarity.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; img_1 = cv2.imread(&#39;/Users/simon/Desktop/envs/simba/troubleshooting/RAT_NOR/project_folder/videos/examples/a.png&#39;).astype(np.uint8)</span>
<span class="sd">        &gt;&gt;&gt; img_2 = cv2.imread(&#39;/Users/simon/Desktop/envs/simba/troubleshooting/RAT_NOR/project_folder/videos/examples/f.png&#39;).astype(np.uint8)</span>
<span class="sd">        &gt;&gt;&gt; ImageMixin.cross_correlation_similarity(img_1=img_1, img_2=img_2)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">img1_flat</span> <span class="o">=</span> <span class="n">img_1</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">img2_flat</span> <span class="o">=</span> <span class="n">img_2</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">mean_1</span><span class="p">,</span> <span class="n">mean_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img1_flat</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img2_flat</span><span class="p">)</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">img1_flat</span> <span class="o">-</span> <span class="n">mean_1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">img2_flat</span> <span class="o">-</span> <span class="n">mean_2</span><span class="p">))</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">img1_flat</span> <span class="o">-</span> <span class="n">mean_1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">img2_flat</span> <span class="o">-</span> <span class="n">mean_2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">N</span> <span class="o">/</span> <span class="n">D</span></div>

<div class="viewcode-block" id="ImageMixin.sliding_cross_correlation_similarity"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.sliding_cross_correlation_similarity">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">([</span><span class="s2">&quot;(uint8[:, :, :], int64)&quot;</span><span class="p">,</span>
           <span class="s2">&quot;(uint8[:, :, :, :], int64)&quot;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">sliding_cross_correlation_similarity</span><span class="p">(</span><span class="n">imgs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                             <span class="n">stride</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the Normalized Cross-Correlation (NCC) similarity for a sequence of images using a sliding window approach.</span>

<span class="sd">        This function calculates the NCC between each image and the image that is `stride` positions before it in the sequence. The result is an array of NCC values representing</span>
<span class="sd">        the similarity between successive images.</span>

<span class="sd">        .. seealso::</span>
<span class="sd">           ``simba.mixins.image_mixin.ImageMixin.cross_correlation_similarity``</span>
<span class="sd">           ``simba.mixins.image_mixin.ImageMixin.cross_correlation_matrix``</span>

<span class="sd">        :param np.ndarray imgs: A 3D array (for grayscale images) or a 4D array (for color images) containing the sequence of images.  Each image should have the same size.</span>
<span class="sd">        :param int stride: The stride length for comparing images. Determines how many steps back in the sequence each image is compared to.</span>
<span class="sd">        :return np.ndarray: A 1D array of NCC values representing the similarity between each image and the image `stride` positions before it. The length of the array is the same as the number of images.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin.read_all_img_in_dir(dir=&#39;/Users/simon/Desktop/envs/simba/troubleshooting/RAT_NOR/project_folder/videos/08102021_DOT_Rat11_12_frames&#39;)</span>
<span class="sd">        &gt;&gt;&gt; imgs = {k: imgs[k] for k in sorted(imgs, key=lambda x: int(x.split(&#39;.&#39;)[0]))}</span>
<span class="sd">        &gt;&gt;&gt; imgs = np.stack(list(imgs.values()))</span>
<span class="sd">        &gt;&gt;&gt; results = ImageMixin.sliding_cross_correlation_similarity(imgs=imgs, stride=1)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">stride</span><span class="p">,</span> <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">img1_flat</span><span class="p">,</span> <span class="n">img2_flat</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">stride</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">mean_1</span><span class="p">,</span> <span class="n">mean_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img1_flat</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img2_flat</span><span class="p">)</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">img1_flat</span> <span class="o">-</span> <span class="n">mean_1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">img2_flat</span> <span class="o">-</span> <span class="n">mean_2</span><span class="p">))</span>
            <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">img1_flat</span> <span class="o">-</span> <span class="n">mean_1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">img2_flat</span> <span class="o">-</span> <span class="n">mean_2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="n">D</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="ImageMixin.cross_correlation_matrix"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.cross_correlation_matrix">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@njit</span><span class="p">([</span><span class="s2">&quot;(uint8[:, :, :],)&quot;</span><span class="p">,</span>
           <span class="s2">&quot;(uint8[:, :, :, :],)&quot;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">cross_correlation_matrix</span><span class="p">(</span><span class="n">imgs</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the cross-correlation matrix for a given array of images.</span>

<span class="sd">        This function calculates the cross-correlation coefficient between each pair of images in the input array.</span>
<span class="sd">        The cross-correlation coefficient is a measure of similarity between two images, with values ranging from</span>
<span class="sd">        -1 (completely dissimilar) to 1 (identical).</span>

<span class="sd">        The function uses the `numba` library for Just-In-Time (JIT) compilation to optimize performance, and</span>
<span class="sd">        `prange` for parallel execution over the image pairs.</span>

<span class="sd">        .. seealso::</span>
<span class="sd">           ``simba.mixins.image_mixin.ImageMixin.cross_correlation_similarity``</span>
<span class="sd">           ``simba.mixins.image_mixin.ImageMixin.sliding_cross_correlation_similarity``</span>

<span class="sd">        .. note::</span>
<span class="sd">           Use greyscale images for faster runtime. Ideally should be move dto GPU.</span>


<span class="sd">        :param np.array imgs: A 3D (or 4D) numpy array of images where the first dimension indexes the images,</span>
<span class="sd">                              and the remaining dimensions are the image dimensions (height, width, [channels]).</span>
<span class="sd">                              - For grayscale images: shape should be (n_images, height, width)</span>
<span class="sd">                              - For color images: shape should be (n_images, height, width, channels)</span>

<span class="sd">        :return np.array: A 2D numpy array representing the cross-correlation matrix, where the element at [i, j]</span>
<span class="sd">                          contains the cross-correlation coefficient between the i-th and j-th images.</span>

<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin.read_all_img_in_dir(dir=&#39;/Users/simon/Desktop/envs/simba/troubleshooting/RAT_NOR/project_folder/videos/examples/test&#39;)</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin.read_all_img_in_dir(dir=&#39;/Users/simon/Desktop/envs/simba/troubleshooting/RAT_NOR/project_folder/videos/08102021_DOT_Rat11_12_frames&#39;)</span>
<span class="sd">        &gt;&gt;&gt; imgs = {k: imgs[k] for k in sorted(imgs, key=lambda x: int(x.split(&#39;.&#39;)[0]))}</span>
<span class="sd">        &gt;&gt;&gt; imgs = np.stack(list(imgs.values()))</span>
<span class="sd">        &gt;&gt;&gt; imgs = ImageMixin.img_stack_to_greyscale(imgs=imgs)</span>
<span class="sd">        &gt;&gt;&gt; results = ImageMixin.cross_correlation_matrix(imgs=imgs)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">img1_flat</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">mean_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img1_flat</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">imgs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">img2_flat</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">mean_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">img2_flat</span><span class="p">)</span>
                <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">img1_flat</span> <span class="o">-</span> <span class="n">mean_1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">img2_flat</span> <span class="o">-</span> <span class="n">mean_2</span><span class="p">))</span>
                <span class="n">D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">img1_flat</span> <span class="o">-</span> <span class="n">mean_1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">img2_flat</span> <span class="o">-</span> <span class="n">mean_2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">N</span> <span class="o">/</span> <span class="n">D</span>
                <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="ImageMixin.find_first_non_uniform_clr_frm"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.find_first_non_uniform_clr_frm">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">find_first_non_uniform_clr_frm</span><span class="p">(</span><span class="n">video_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">],</span>
                                       <span class="n">start_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                       <span class="n">end_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find the first frame of non-uniform color in a video.</span>

<span class="sd">        .. note::</span>
<span class="sd">           Helpful in the ``GetPixelsPerMillimeterInterface`` to ensure that a viable frame is pulled up.</span>

<span class="sd">        :param Union[str, os.PathLike, cv2.VideoCapture] video_path: The path to a video file on disk, or a cv2.VideoCapture object.</span>
<span class="sd">        :param Optional[int] start_idx: The first frame (where to start searching for the non-uniform color image). Default: 0 which equals the first frame. None also equals start searching at the first frame.</span>
<span class="sd">        :param Optional[int] end_idx: The last frame (where to end searching for the non-uniform color image). Default: None, which equals 1s into the video.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">check_instance</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s1">&#39;find_first_non_uniform_clr_frm&#39;</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="n">video_path</span><span class="p">,</span> <span class="n">accepted_types</span><span class="o">=</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">cv2</span><span class="o">.</span><span class="n">VideoCapture</span><span class="p">))</span>
        <span class="n">video_meta_data</span> <span class="o">=</span> <span class="n">get_video_meta_data</span><span class="p">(</span><span class="n">video_path</span><span class="o">=</span><span class="n">video_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&gt;=</span> <span class="n">end_idx</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">FrameRangeError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Start frame (</span><span class="si">{</span><span class="n">start_idx</span><span class="si">}</span><span class="s1">) has to be before the end frame (</span><span class="si">{</span><span class="n">end_idx</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;find_first_non_uniform_clr_frm&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">check_int</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;start_idx&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">start_idx</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">video_meta_data</span><span class="p">[</span><span class="s1">&#39;frame_count&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">video_meta_data</span><span class="p">[</span><span class="s1">&#39;frame_count&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">start_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FrameRangeError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Start frame idx </span><span class="si">{</span><span class="p">(</span><span class="n">start_idx</span><span class="p">)</span><span class="si">}</span><span class="s1"> has to be None or an integer&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;find_first_non_uniform_clr_frm&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">check_int</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;end_idx&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">end_idx</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">video_meta_data</span><span class="p">[</span><span class="s1">&#39;frame_count&#39;</span><span class="p">]):</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">video_meta_data</span><span class="p">[</span><span class="s1">&#39;frame_count&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">end_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">video_meta_data</span><span class="p">[</span><span class="s1">&#39;fps&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">FrameRangeError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;End frame idx </span><span class="si">{</span><span class="p">(</span><span class="n">end_idx</span><span class="p">)</span><span class="si">}</span><span class="s1"> has to be None or an integer&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;find_first_non_uniform_clr_frm&#39;</span><span class="p">)</span>

        <span class="n">first_frm</span> <span class="o">=</span> <span class="n">read_frm_of_video</span><span class="p">(</span><span class="n">video_path</span><span class="o">=</span><span class="n">video_path</span><span class="p">,</span> <span class="n">frame_index</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">frame_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start_idx</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">end_idx</span><span class="p">)):</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">read_frm_of_video</span><span class="p">(</span><span class="n">video_path</span><span class="o">=</span><span class="n">video_path</span><span class="p">,</span> <span class="n">frame_index</span><span class="o">=</span><span class="n">frame_index</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">frame</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">clr_cnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">frame</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clr_cnt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">frame</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">clr_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">frame</span>
        <span class="k">return</span> <span class="n">first_frm</span></div>

<div class="viewcode-block" id="ImageMixin.get_blob_locations"><a class="viewcode-back" href="../../../simba.mixins.html#simba.mixins.image_mixin.ImageMixin.get_blob_locations">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_blob_locations</span><span class="p">(</span><span class="n">video_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">],</span>
                           <span class="n">batch_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>
                           <span class="n">gpu</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                           <span class="n">verbose</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                           <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detects the location of the largest blob in each frame of a video. Processes frames in batches and</span>
<span class="sd">        optionally uses GPU for acceleration. Results can be saved to a specified path or returned as a NumPy array.</span>

<span class="sd">        :param Union[str, os.PathLike] video_path: Path to the video file from which to extract frames.</span>
<span class="sd">        :param Optional[int] batch_size: Number of frames to process in each batch. Default is 2000.</span>
<span class="sd">        :param Optional[bool] gpu: Whether to use GPU acceleration for processing. Default is False.</span>
<span class="sd">        :param Optional[bool] verbose: Whether to print progress and status messages. Default is True.</span>
<span class="sd">        :param Optional[Union[str, os.PathLike]] save_path: Path to save the results as a CSV file. If None, results are not saved.</span>

<span class="sd">        :return: A NumPy array of shape (N, 2) where N is the number of frames, containing the X and Y coordinates</span>
<span class="sd">                 of the centroid of the largest blob in each frame. If `save_path` is provided, returns None.</span>
<span class="sd">        :example:</span>
<span class="sd">        &gt;&gt;&gt; x = ImageMixin.get_blob_locations(video_path=r&quot;/mnt/c/troubleshooting/RAT_NOR/project_folder/videos/2022-06-20_NOB_DOT_4_downsampled_bg_subtracted.mp4&quot;, gpu=True)</span>
<span class="sd">        &gt;&gt;&gt; x = ImageMixin.get_blob_locations(video_path=r&quot;C:\troubleshooting\RAT_NOR\project_folder\videos\2022-06-20_NOB_IOT_1_bg_subtracted.mp4&quot;, gpu=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">timer</span> <span class="o">=</span> <span class="n">SimbaTimer</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">video_meta</span> <span class="o">=</span> <span class="n">get_video_meta_data</span><span class="p">(</span><span class="n">video_path</span><span class="o">=</span><span class="n">video_path</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">video_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_fn_ext</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">video_path</span><span class="p">)</span>
        <span class="n">check_int</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">get_blob_locations</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> batch_size&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">batch_size</span> <span class="o">&gt;</span> <span class="n">video_meta</span><span class="p">[</span><span class="s1">&#39;frame_count&#39;</span><span class="p">]:</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="n">video_meta</span><span class="p">[</span><span class="s1">&#39;frame_count&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">save_path</span><span class="p">)):</span> <span class="k">raise</span> <span class="n">NotDirectoryError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Save path is not a valid directory&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">get_blob_locations</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">check_valid_boolean</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">gpu</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">get_blob_locations</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> gpu&#39;</span><span class="p">)</span>
        <span class="n">check_valid_boolean</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">gpu</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">get_blob_locations</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> verbose&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gpu</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check_nvidea_gpu_available</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">FFMPEGCodecGPUError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;No GPU detected, try to set GPU to False&#39;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ImageMixin</span><span class="o">.</span><span class="n">get_blob_locations</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">frame_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">video_meta</span><span class="p">[</span><span class="s1">&#39;frame_count&#39;</span><span class="p">]))</span>
        <span class="n">frame_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame_ids</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_ids</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">)]</span>
        <span class="n">core_cnt</span> <span class="o">=</span> <span class="n">find_core_cnt</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting blob location detection...&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">frame_batch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frame_ids</span><span class="p">)):</span>
            <span class="n">start_frm</span><span class="p">,</span> <span class="n">end_frm</span> <span class="o">=</span> <span class="n">frame_ids</span><span class="p">[</span><span class="n">frame_batch</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">frame_ids</span><span class="p">[</span><span class="n">frame_batch</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">gpu</span><span class="p">:</span>
                <span class="n">imgs</span> <span class="o">=</span> <span class="n">read_img_batch_from_video_gpu</span><span class="p">(</span><span class="n">video_path</span><span class="o">=</span><span class="n">video_path</span><span class="p">,</span> <span class="n">start_frm</span><span class="o">=</span><span class="n">start_frm</span><span class="p">,</span> <span class="n">end_frm</span><span class="o">=</span><span class="n">end_frm</span><span class="p">,</span>  <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">out_format</span><span class="o">=</span><span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="n">greyscale</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">imgs</span> <span class="o">=</span> <span class="n">ImageMixin</span><span class="o">.</span><span class="n">read_img_batch_from_video</span><span class="p">(</span><span class="n">video_path</span><span class="o">=</span><span class="n">video_path</span><span class="p">,</span> <span class="n">start_frm</span><span class="o">=</span><span class="n">start_frm</span><span class="p">,</span> <span class="n">end_frm</span><span class="o">=</span><span class="n">end_frm</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">imgs</span> <span class="o">=</span> <span class="n">ImageMixin</span><span class="o">.</span><span class="n">img_stack_to_greyscale</span><span class="p">(</span><span class="n">imgs</span><span class="o">=</span><span class="n">imgs</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start_frm</span><span class="p">,</span> <span class="n">end_frm</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">img_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">img_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start_frm</span><span class="p">,</span> <span class="n">end_frm</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span>
                <span class="n">img_dict</span><span class="p">[</span><span class="n">img_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">imgs</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span>
            <span class="n">batch_results</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">img_dict</span> <span class="o">=</span> <span class="p">[{</span><span class="n">k</span><span class="p">:</span> <span class="n">img_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">subset</span><span class="p">}</span> <span class="k">for</span> <span class="n">subset</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">core_cnt</span><span class="p">)]</span>
            <span class="k">del</span> <span class="n">imgs</span>
            <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">core_cnt</span><span class="p">,</span> <span class="n">maxtasksperchild</span><span class="o">=</span><span class="n">Defaults</span><span class="o">.</span><span class="n">LARGE_MAX_TASK_PER_CHILD</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">constants</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">find_largest_blob_location</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">video_name</span><span class="o">=</span><span class="n">video_name</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span><span class="n">constants</span><span class="p">,</span> <span class="n">img_dict</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">)):</span>
                    <span class="n">batch_results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">batch_results</span><span class="p">)</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">timer</span><span class="o">.</span><span class="n">stop_timer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">])</span>
            <span class="n">write_df</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">file_type</span><span class="o">=</span><span class="n">Formats</span><span class="o">.</span><span class="n">CSV</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">stdout_success</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Video </span><span class="si">{</span><span class="n">video_meta</span><span class="p">[</span><span class="s2">&quot;video_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> blob detection complete, saved at </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="o">=</span><span class="n">timer</span><span class="o">.</span><span class="n">elapsed_time_str</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stdout_success</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Video </span><span class="si">{</span><span class="n">video_meta</span><span class="p">[</span><span class="s2">&quot;video_name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> blob detection complete&#39;</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="o">=</span><span class="n">timer</span><span class="o">.</span><span class="n">elapsed_time_str</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span></div></div>


<span class="c1">#x = ImageMixin.get_blob_locations(video_path=r&quot;C:\troubleshooting\RAT_NOR\project_folder\videos\2022-06-20_NOB_DOT_4_downsampled_bg_subtracted.mp4&quot;, gpu=True)</span>
<span class="c1"># imgs = ImageMixin().read_all_img_in_dir(dir=&#39;/Users/simon/Desktop/envs/simba/troubleshooting/RAT_NOR/project_folder/videos/examples&#39;)</span>
<span class="c1"># imgs = np.stack(imgs.values())</span>
<span class="c1"># mse = ImageMixin().img_sliding_mse(imgs=imgs, slide_size=2)</span>


<span class="c1"># img_1 = cv2.imread(&#39;/Users/simon/Desktop/envs/simba/troubleshooting/RAT_NOR/project_folder/videos/examples/.png&#39;, 0).astype(np.float32)</span>
<span class="c1"># img_2 = cv2.imread(&#39;/Users/simon/Desktop/envs/simba/troubleshooting/RAT_NOR/project_folder/videos/examples/4.png&#39;, 0).astype(np.float32)</span>
<span class="c1"># ImageMixin.img_emd(img_1=img_1, img_2=img_2, lower_bound=0.5, verbose=True)</span>

    <span class="c1">#</span>
    <span class="c1"># def segment_img_horizontal(img: np.ndarray, pct: int, lower: Optional[bool] = True,</span>
    <span class="c1">#                            both: Optional[bool] = False</span>


<span class="c1"># img = cv2.imread(&#39;/Users/simon/Desktop/test.png&#39;)</span>
<span class="c1"># img = ImageMixin.segment_img_vertical(img=img, pct=20, both=True)</span>
<span class="c1"># cv2.imshow(&#39;sdsdf&#39;, img)</span>
<span class="c1"># cv2.waitKey(5000)</span>


<span class="c1"># bw_img = ImageMixin.img_to_bw(img=img, invert=False)</span>
<span class="c1"># cv2.imshow(&#39;sdsdf&#39;, bw_img)</span>
<span class="c1"># cv2.waitKey(5000)</span>




<span class="c1"># imgs = np.stack(list(imgs.values()))</span>
<span class="c1"># imgs_gray = ImageMixin().img_stack_to_greyscale(imgs=imgs)</span>
<span class="c1"># data = pd.read_csv(&#39;/Users/simon/Desktop/envs/troubleshooting/Emergence/project_folder/csv/outlier_corrected_movement_location/Example_1.csv&#39;, nrows=11).fillna(-1)</span>
<span class="c1"># nose_array, tail_array = data.loc[0:10, [&#39;Nose_x&#39;, &#39;Nose_y&#39;]].values.astype(np.float32), data.loc[0:10, [&#39;Tail_base_x&#39;, &#39;Tail_base_y&#39;]].values.astype(np.float32)</span>
<span class="c1"># nose_shapes, tail_shapes = [], []</span>
<span class="c1"># from simba.mixins.geometry_mixin import GeometryMixin</span>
<span class="c1"># for frm_data in nose_array: nose_shapes.append(GeometryMixin().bodyparts_to_circle(frm_data, 80))</span>
<span class="c1"># for frm_data in tail_array: tail_shapes.append(GeometryMixin().bodyparts_to_circle(frm_data, 80))</span>
<span class="c1"># shapes = np.array(np.vstack([nose_shapes, tail_shapes]).T)</span>
<span class="c1"># sliced_images = ImageMixin().slice_shapes_in_imgs(imgs=imgs_gray, shapes=shapes)</span>

<span class="c1"># imgs_.shape</span>
<span class="c1"># imgs = ImageMixin().read_all_img_in_dir(dir=&#39;/Users/simon/Desktop/envs/troubleshooting/two_black_animals_14bp/project_folder/Together_4_cropped_frames&#39;)</span>
<span class="c1"># imgs_1 = np.stack(imgs.values())</span>
<span class="c1"># mse = ImageMixin().img_sliding_mse(imgs=imgs_1, slide_size=2)</span>
<span class="c1"># #imgs_2 = np.roll(imgs_1,-1, axis=0)</span>
<span class="c1"># #mse = ImageMixin().img_mse(imgs_1=imgs_1, imgs_2=imgs_1)</span>
<span class="c1"># mse = ImageMixin().img_sliding_mse(imgs=imgs_1, slide_size=2)</span>

<span class="c1"># img_1 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/0.png&#39;).astype(np.uint8)</span>
<span class="c1"># img_2 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/10.png&#39;).astype(np.uint8)</span>
<span class="c1">#</span>
<span class="c1"># img_1 = cv2.cvtColor(img_1, cv2.COLOR_BGR2GRAY)</span>
<span class="c1"># img_2 = cv2.cvtColor(img_2, cv2.COLOR_BGR2GRAY)</span>
<span class="c1">#</span>
<span class="c1"># imgs_1 = np.stack((img_1, img_2))</span>
<span class="c1"># imgs_2 = np.stack((img_2, img_2))</span>
<span class="c1"># ImageMixin.img_mse(imgs_1=imgs_1, imgs_2=imgs_2)</span>

<span class="c1"># ImageMixin.img_mse_test(imgs_1=imgs_1)</span>


<span class="c1"># res = ImageMixin.img_moments(img=img_1, hu_moments=True)</span>
<span class="c1"># img_1 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/0.png&#39;).astype(np.uint8)</span>
<span class="c1"># img_2 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/10.png&#39;).astype(np.uint8)</span>
<span class="c1"># ImageMixin.get_contourmatch(img_1=img_1, img_2=img_2, mode=&#39;exterior&#39;)</span>


<span class="c1"># img = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/Emergence/project_folder/videos/img_comparisons_4/1.png&#39;)</span>
<span class="c1"># img_video = cv2.VideoCapture(&#39;/Users/simon/Desktop/envs/troubleshooting/Emergence/project_folder/videos/Example_1.mp4&#39;)</span>
<span class="c1"># data_path = &#39;/Users/simon/Desktop/envs/troubleshooting/Emergence/project_folder/csv/outlier_corrected_movement_location/Example_1.csv&#39;</span>
<span class="c1"># data = pd.read_csv(data_path, nrows=4, usecols=[&#39;Nose_x&#39;, &#39;Nose_y&#39;]).fillna(-1).values.astype(np.int64)</span>
<span class="c1"># shapes = []</span>
<span class="c1"># for frm_data in data: shapes.append(GeometryMixin().bodyparts_to_circle(frm_data, 100))</span>
<span class="c1">#</span>
<span class="c1"># ImageMixin().slice_shapes_in_img(img=(img_video, 1), shapes=shapes)</span>


<span class="c1"># img_2 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/3.png&#39;).astype(np.uint8)</span>
<span class="c1"># ImageMixin.get_contourmatch(img_1=img_1, img_2=img_2, method=&#39;exterior&#39;)</span>

<span class="c1"># img = cv2.VideoCapture(&#39;/Users/simon/Desktop/envs/simba_dev/tests/data/test_projects/zebrafish/project_folder/videos/20200730_AB_7dpf_850nm_0003.mp4&#39;)</span>
<span class="c1"># ImageMixin.slice_shapes_in_img(img=(img, 1))</span>


<span class="c1"># img_1 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/0.png&#39;).astype(np.uint8)</span>
<span class="c1"># img_2 = cv2.imread(&#39;/Users/simon/Desktop/envs/troubleshooting/khan/project_folder/videos/stitched_frames/1.png&#39;).astype(np.uint8)</span>
<span class="c1"># ImageMixin.get_contourmatch(img_1=img_1, img_2=img_2, method=&#39;all&#39;, canny=True)</span>
<span class="c1">#</span>

<span class="c1">#</span>
<span class="c1"># from simba.utils.data import create_color_palette</span>
<span class="c1"># clrs = create_color_palette(pallete_name=&#39;inferno&#39;, increments=4, as_int=True)</span>
<span class="c1"># imgs_stack = np.full((5, 10, 10, 3), -1)</span>
<span class="c1"># for cnt, i in enumerate(clrs): imgs_stack[cnt] = ImageMixin.create_uniform_img(size=(10, 10), color=tuple(i))</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="c1"># ImageMixin.img_matrix_mse(imgs=imgs_stack)</span>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, sronilsson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>